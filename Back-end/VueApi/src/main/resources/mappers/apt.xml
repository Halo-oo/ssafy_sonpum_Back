<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.vue.model.mapper.HouseMapMapper">

	<!-- 시도정보 전체 호출 -->
	<select id="getSido" resultType="sidoGugunCodeDto">
		select left(sidoCode,2) sidoCode, sidoName
		from sidocode
		order by sidoCode
	</select>
	
	<!-- 선택한 시도에 포함된 구군 정보 호출 -->
	<select id="getGugunInSido" parameterType="string" resultType="sidoGugunCodeDto">
		select left(gugunCode,5) gugunCode, gugunName
		from guguncode
		where left(gugunCode,2) = #{sido}
		order by gugunCode
	</select>
	
	<!-- 선택한 구군에 포함된 동 정보 호출 -->
	<select id="getDongInGugun" parameterType="string" resultType="houseDealDongDto">
		select distinct dongName, dongCode
		from dongcode
		where left(dongCode, 5) = #{gugun}
		order by dongName;
	</select>
	
	<!-- 선택한 동에 포함된 아파트 정보 호출 (+ 검색) -->
	<!-- <select id="getAptInDong" parameterType="string" resultType="houseDealInfoDto">
		select deal.addressId, address.apartName, address.dongCode, address.buildYear, deal.dealAmount, deal.dealYear, deal.dealMonth, deal.dealDay, deal.area, deal.floor
		from house_deal deal, address
		left join sidocode si 
		on left(address.dongcode, 2) = left(si.sidocode, 2)
		left join guguncode gu
		on left(address.dongcode, 5) = left(gu.guguncode, 5)
		where dongCode = #{dong}
		order by deal.dealYear desc
		limit 0, 100
	</select> -->
	<select id="getAptInDong" parameterType="houseParameterDto" resultType="houseDealInfoDto">
		select deal.addressId, address.apartName, address.dongCode, address.buildYear, deal.dealAmount, deal.dealYear, deal.dealMonth, deal.dealDay, deal.area, deal.floor
		from house_deal deal, address
		left join sidocode si 
		on left(address.dongcode, 2) = left(si.sidocode, 2)
		left join guguncode gu
		on left(address.dongcode, 5) = left(gu.guguncode, 5)
		where dongCode = #{dongCode}
			<if test="word != null and word != ''">
				<if test="key == 'amount'">
					and <![CDATA[convert(deal.dealAmount, signed) <= #{word}]]>
				</if>
				<if test="key == 'area'">
					and <![CDATA[convert(deal.area, signed) >= #{word}]]>
				</if>
				<if test="key == 'floor'">
					and <![CDATA[convert(deal.floor, signed) >= #{word}]]>
				</if>
				<if test="key == 'buildYear'">
					and <![CDATA[address.buildYear >= #{word}]]>
				</if>
				<if test="key == 'apartName'">
					and address.apartName like concat('%', #{word}, '%')
				</if>
				<if test="key == 'dealDate'">
					and concat(deal.dealYear, deal.dealMonth, deal.dealDay) = #{word}
				</if>
			</if>
		order by deal.dealYear desc
		limit 0, 100
	</select>
	
	
</mapper>